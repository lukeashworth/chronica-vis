 // Define the JSON schema as a JavaScript object
let campaignData = {"campaign":{"id":21292,"name":"Bitd","about":null,"created_at":"2024-08-12T20:24:49.715Z","updated_at":"2024-08-12T20:24:49.715Z","gm_secrets":"","game_system":"Bitd","party_wealth":"0.0","players_count":1,"hidden_links":[],"ability_types":[],"stat_groups":[],"characters":[{"id":116901,"name":"Miwa Rival","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-13T12:11:20.389Z","updated_at":"2024-08-18T18:46:48.428Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":null,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83221,"character_id":116901,"kinship_id":null,"title":"Rival of","notes":"","created_at":"2024-08-18T18:47:26.086Z","updated_at":"2024-08-18T18:47:26.086Z","character_alt_id":117077,"inventory_id":null,"place_id":null,"preposition":"at","owner":false,"pc_secret":false}]},{"id":116902,"name":"Miwa ally","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-13T12:11:34.454Z","updated_at":"2024-08-18T18:47:53.130Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":null,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83206,"character_id":116902,"kinship_id":null,"title":"Ally of","notes":"","created_at":"2024-08-18T13:38:00.256Z","updated_at":"2024-08-18T18:48:09.083Z","character_alt_id":117077,"inventory_id":null,"place_id":null,"preposition":"at","owner":false,"pc_secret":false}]},{"id":117071,"name":"Red scarf 1","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T13:59:10.498Z","updated_at":"2024-08-18T13:59:10.498Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":null,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83209,"character_id":117071,"kinship_id":14690,"title":"","notes":"","created_at":"2024-08-18T13:59:41.841Z","updated_at":"2024-08-18T13:59:41.841Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"at","owner":false,"pc_secret":false}]},{"id":117073,"name":"Black Heart STANDIN","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T14:34:10.431Z","updated_at":"2024-08-18T14:34:10.431Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":null,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83211,"character_id":117073,"kinship_id":14689,"title":"STANDIN","notes":"","created_at":"2024-08-18T14:35:46.159Z","updated_at":"2024-08-18T14:47:10.937Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]},{"id":117070,"name":"Crafter","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T12:50:59.879Z","updated_at":"2024-08-18T18:41:38.997Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":34522,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83205,"character_id":117070,"kinship_id":14689,"title":"","notes":"","created_at":"2024-08-18T13:34:05.814Z","updated_at":"2024-08-18T13:34:05.814Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"in","owner":false,"pc_secret":false},{"id":83207,"character_id":117070,"kinship_id":null,"title":"Friends Of","notes":"","created_at":"2024-08-18T13:39:04.271Z","updated_at":"2024-08-18T13:39:04.271Z","character_alt_id":116901,"inventory_id":null,"place_id":null,"preposition":"at","owner":false,"pc_secret":false},{"id":83208,"character_id":117070,"kinship_id":null,"title":"Enemy OF","notes":"","created_at":"2024-08-18T13:39:14.359Z","updated_at":"2024-08-18T13:39:14.359Z","character_alt_id":116902,"inventory_id":null,"place_id":null,"preposition":"at","owner":false,"pc_secret":false},{"id":83220,"character_id":117070,"kinship_id":14727,"title":"","notes":"","created_at":"2024-08-18T18:44:58.059Z","updated_at":"2024-08-18T18:45:05.436Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]},{"id":117075,"name":"Susan","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T18:41:52.305Z","updated_at":"2024-08-18T18:41:52.305Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":34522,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83218,"character_id":117075,"kinship_id":14727,"title":"","notes":"","created_at":"2024-08-18T18:44:27.841Z","updated_at":"2024-08-18T18:44:34.805Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]},{"id":117076,"name":"Polish","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T18:42:34.643Z","updated_at":"2024-08-18T18:42:34.643Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":34522,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83219,"character_id":117076,"kinship_id":14727,"title":"","notes":"","created_at":"2024-08-18T18:44:49.214Z","updated_at":"2024-08-18T18:44:49.214Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]},{"id":117077,"name":"Miwa","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T18:43:00.513Z","updated_at":"2024-08-18T18:43:00.513Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":34522,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83216,"character_id":117077,"kinship_id":14727,"title":"","notes":"","created_at":"2024-08-18T18:43:55.317Z","updated_at":"2024-08-18T18:43:55.317Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]},{"id":117078,"name":"Brian","gender":"Unknown","race":"","npc_class":"","description":"","notes":"","alignment":"","created_at":"2024-08-18T18:43:10.140Z","updated_at":"2024-08-18T18:43:10.140Z","disposition":"Unknown","dead":null,"faction":"","title":"","campaign_id":21292,"player_id":34522,"special":"","gm_secrets":"","pc_secret":false,"ability_ids":[],"personal_secrets":"","gender_write_in":"","profile_template_id":null,"status":"Alive","private":false,"char_flairs":[],"char_stat_data":[],"konnections":[{"id":83215,"character_id":117078,"kinship_id":14727,"title":"","notes":"","created_at":"2024-08-18T18:43:48.222Z","updated_at":"2024-08-18T18:43:48.222Z","character_alt_id":null,"inventory_id":null,"place_id":null,"preposition":"","owner":false,"pc_secret":false}]}],"domains":[],"domain_stats":[],"encounters":[],"entities":[],"events":[],"inventories":[{"id":73274,"name":"Player Inventory","description":null,"created_at":"2024-08-12T20:24:49.732Z","updated_at":"2024-08-12T20:24:49.732Z","closed":false,"campaign_id":21292,"player_id":34522,"shop":null,"party":null,"order":null,"pc_secret":false,"encounter_id":null,"position":null,"master_library":false,"shop_wealth":"0.0","gm_secrets":null,"character_ownership_id":null,"kinship_id":null,"inventory_type":"player","quest_id":null,"inventory_items":[]},{"id":73275,"name":"Party Inventory","description":null,"created_at":"2024-08-12T20:24:49.744Z","updated_at":"2024-08-12T20:24:49.744Z","closed":false,"campaign_id":21292,"player_id":null,"shop":null,"party":null,"order":null,"pc_secret":false,"encounter_id":null,"position":null,"master_library":false,"shop_wealth":"0.0","gm_secrets":null,"character_ownership_id":null,"kinship_id":null,"inventory_type":"party","quest_id":null,"inventory_items":[]},{"id":73299,"name":"Item Library","description":null,"created_at":"2024-08-13T12:20:14.273Z","updated_at":"2024-08-13T12:20:14.273Z","closed":false,"campaign_id":21292,"player_id":null,"shop":null,"party":null,"order":null,"pc_secret":false,"encounter_id":null,"position":null,"master_library":false,"shop_wealth":"0.0","gm_secrets":null,"character_ownership_id":null,"kinship_id":null,"inventory_type":"library","quest_id":null,"inventory_items":[]}],"adventure_notes":[],"kinships":[{"id":14689,"kintype":"","name":"The Black Hearts","description":"","notes":"","gm_secrets":"","location":"","created_at":"2024-08-13T12:12:04.788Z","updated_at":"2024-08-18T13:35:30.078Z","campaign_id":21292,"pc_secret":false,"position":null,"character_id":null,"kinship_wealth":"0.0","private_ranking_members":false,"reputation_title_override":"Reputation","track_reputation":false,"open_enrollment":false,"kin_stat_data":[],"kinship_ranks":[]},{"id":14690,"kintype":"","name":"The Red Scarves","description":"","notes":"","gm_secrets":"","location":"","created_at":"2024-08-13T13:12:19.452Z","updated_at":"2024-08-18T13:35:54.006Z","campaign_id":21292,"pc_secret":false,"position":null,"character_id":null,"kinship_wealth":"0.0","private_ranking_members":false,"reputation_title_override":"Reputation","track_reputation":false,"open_enrollment":false,"kin_stat_data":[],"kinship_ranks":[]},{"id":14727,"kintype":"","name":"Player Gang","description":"","notes":"","gm_secrets":"","location":"","created_at":"2024-08-18T14:08:59.084Z","updated_at":"2024-08-18T18:42:19.696Z","campaign_id":21292,"pc_secret":false,"position":null,"character_id":null,"kinship_wealth":"0.0","private_ranking_members":false,"reputation_title_override":"Reputation","track_reputation":false,"open_enrollment":false,"kin_stat_data":[],"kinship_ranks":[]},{"id":14728,"kintype":"","name":"Kinship 4","description":"","notes":"","gm_secrets":"","location":"","created_at":"2024-08-18T14:09:10.485Z","updated_at":"2024-08-18T14:11:41.045Z","campaign_id":21292,"pc_secret":false,"position":null,"character_id":null,"kinship_wealth":"0.0","private_ranking_members":false,"reputation_title_override":"Reputation","track_reputation":false,"open_enrollment":false,"kin_stat_data":[],"kinship_ranks":[]}],"maps":[],"places":[],"players":[{"id":10369,"first_name":"Luke","email":"1lukeashworth@gmail.com","created_at":"2020-07-22T16:05:56.033Z","updated_at":"2024-08-18T12:48:25.479Z","password_digest":"$2a$10$S269vibJnwJf.EM6fpi0ou9mxLwFT92KwSn6t8AklYvTgFruWEovS","image_uid":null,"user_theme":"classic_theme","system_admin":false,"beta_group":null,"remember_digest":"$2a$10$a5D9W2LMhiHrvOsT2uPVIOfIpP7FY6H9.b6BWY7f57Vblh3ta4bjO","activation_digest":"$2a$10$GumtPDakUaFm2JNtxBGtae7YggIP5imGyd68yJ98VXGtWpPjmxZrG","activated":true,"activated_at":"2020-07-22T16:06:35.924Z","username":"churchoffunk","forum_admin":false,"last_name":"Ashworth","stripe_customer_ref":null,"charter_member":false,"reset_digest":null,"reset_sent_at":"2024-08-12T20:23:28.186Z","tos_agree":true,"time_zone":"UTC","referral_token":"7229cba90527e65b3b3a","godmode":false}],"plots":[],"quests":[]},"export_created_at":"2024-08-18T18:49:43.287Z"}


// Function to calculate circular positions
function calculateCircularPositions(centerX, centerY, radius, totalNodes) {
    const positions = [];
    for (let i = 0; i < totalNodes; i++) {
        const angle = (i / totalNodes) * 2 * Math.PI;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        positions.push({ x, y });
    }
    return positions;
}
const nodeStyles = {
    character: {
        color: { background: '#379683', border: '#28675B' },
        font: { color: '#FFFFFF' },
         shape: 'box',
        shadow: { enabled: true, color: 'rgba(0,0,0,0.5)', size: 10, x: 5, y: 5 },
        shapeProperties: { borderRadius: 12 }
    },
    npc: {
     shape: 'box',
        color: { background: '#557A95', border: '#415A73' },
        font: { color: '#FFFFFF' },
        shadow: { enabled: true, color: 'rgba(0,0,0,0.5)', size: 10, x: 5, y: 5 },
        shapeProperties: { borderRadius: 12 }
    },
    kinship: {
        color: { background: '#FFD700', border: '#E5B700' },
        font: { color: '#000000' },
        shadow: { enabled: true, color: 'rgba(0,0,0,0.5)', size: 10, x: 5, y: 5 },
        shape: 'box',
        shapeProperties: { borderRadius: 6 }
    },
};



// Create nodes and edges arrays
const nodes = [];
const edges = [];

function getNodeStyle(character, isKinship, isStandin) {
		if (character.player_id) { // Use player_id for identifying player characters
        return nodeStyles.character; // Player characters style
    } else if (isStandin) {
        return nodeStyles.kinship; // STANDIN characters get the kinship style
    } else if (isKinship) {
        return nodeStyles.kinship; // Kinship style for characters associated with a kinship
    } else {
        return nodeStyles.npc; // NPCs style
    }
}


// Define color constants
const RED_LOW_THREAT = "#FF9999";
const RED_MEDIUM_THREAT = "#FF4D4D";
const RED_HIGH_THREAT = "#B20000";

const GREEN_LOW_SUPPORT = "#99FF99";
const GREEN_MEDIUM_SUPPORT = "#4DFF4D";
const GREEN_HIGH_SUPPORT = "#00B200";

function getEdgeStyle(connection) {
    const t = connection.title.toLowerCase();

    // Direct mappings for specific keywords
    if (t.includes("rival")) return RED_HIGH_THREAT;
    if (t.includes("ally")) return GREEN_HIGH_SUPPORT;

    // Mappings for status levels
    const statusMap = {
        "+1": GREEN_LOW_SUPPORT,
        "+2": GREEN_MEDIUM_SUPPORT,
        "+3": GREEN_HIGH_SUPPORT,
        "-1": RED_LOW_THREAT,
        "-2": RED_MEDIUM_THREAT,
        "-3": RED_HIGH_THREAT
    };

    // Find and return the corresponding color if any status is found
    for (const [status, color] of Object.entries(statusMap)) {
        if (t.includes(status)) return color;
    }

    // Default return value if no match is found
    return "Status not recognized";
}
// Calculate positions for kinship nodes in a larger circle
const kinshipRadius = 500;
const kinshipPositions = calculateCircularPositions(0, 0, kinshipRadius, campaignData.campaign.kinships.length);
campaignData.campaign.kinships.forEach((kinship, kinshipIndex) => {
    const kinshipCenter = kinshipPositions[kinshipIndex];

    // Get characters that belong to this kinship
    const kinshipCharacters = campaignData.campaign.characters.filter(character => {
        return character.konnections.some(k => k.kinship_id === kinship.id);
    });

    // Identify if there's a "STANDIN" character connected to this kinship
    const standinCharacter = kinshipCharacters.find(character => character.name.toLowerCase().includes("standin"));

    if (standinCharacter) {
        // Place the "STANDIN" character where the kinship node would have been
        nodes.push({
            id: standinCharacter.id,
            label: standinCharacter.name,
            ...getNodeStyle(standinCharacter, true, true),  // Pass true for isStandin
            x: kinshipCenter.x,
            y: kinshipCenter.y,
            fixed: { x: true, y: true }
        });

        // Calculate positions for other characters around the "STANDIN" character
        const characterRadius = 100;
        const characterPositions = calculateCircularPositions(kinshipCenter.x, kinshipCenter.y, characterRadius, kinshipCharacters.length);

        kinshipCharacters.forEach((character, i) => {
            if (character.id !== standinCharacter.id) {
                let position = characterPositions[i];
                nodes.push({
                    id: character.id,
                    label: character.name,
                    ...getNodeStyle(character, true, false),  // Pass true for isKinship
                    x: position.x,
                    y: position.y,
                });
                // Connect them to the "STANDIN"
                edges.push({
                    from: standinCharacter.id,
                    to: character.id,
                    arrows: 'to, from',
                });
            }

            // Add connections between the other characters
            character.konnections.forEach(connection => {
           			console.log(connection)
                if (connection.character_alt_id) {
                    edges.push({
                        from: character.id,
                        to: connection.character_alt_id,
                        label: connection.preposition + " " + connection.title,
                        arrows: 'to, from',
                        color: { color: getEdgeStyle(connection) },

                    });
                }
            });
        });
    } else {
        // If no "STANDIN", render the kinship node and connect characters to it
        nodes.push({
            id: `kinship_${kinship.id}`,
            label: kinship.name,
            ...getNodeStyle(kinship, true, false),  // Pass true for isKinship
            x: kinshipCenter.x,
            y: kinshipCenter.y,
            fixed: { x: true, y: true }
        });

        // Calculate positions for characters within the kinship's circle
        const characterRadius = 100;
        const characterPositions = calculateCircularPositions(kinshipCenter.x, kinshipCenter.y, characterRadius, kinshipCharacters.length);

        kinshipCharacters.forEach((character, i) => {
            let position = characterPositions[i];
            nodes.push({
                id: character.id,
                label: character.name,
                ...getNodeStyle(character, true, false),  // Pass true for isKinship
                x: position.x,
                y: position.y,
            });

            // Add a red edge from the kinship to the character
            edges.push({
                from: `kinship_${kinship.id}`,
                to: character.id,
                color: { color: 'red' },
                arrows: 'to, from',
            });

            // Add edges based on other konnections
            character.konnections.forEach(connection => {
            
                if (connection.character_alt_id) {
                    edges.push({
                        from: character.id,
                        to: connection.character_alt_id,
                        label: connection.preposition + " " + connection.title,
                        arrows: 'to, from',
                        color: { color: getEdgeStyle(connection) },
                    });
                }
            });
        });
    }
});


// Add non-kinship characters to the center if needed
const nonKinshipNodes = campaignData.campaign.characters.filter(character => {
    return !character.konnections.some(k => k.kinship_id);
});


nonKinshipNodes.forEach(character => {

    nodes.push({
        id: character.id,
        label: character.name,
        ...getNodeStyle(character, null),
        x: 0,
        y: 0
    });

    // Add edges based on konnections
    character.konnections.forEach(connection => {
        if (connection.character_alt_id) {
            edges.push({
                from: character.id,
                to: connection.character_alt_id,
                label: connection.preposition + " " + connection.title,
                arrows: 'to',
                color: { color: getEdgeStyle(connection) },
            });
        }
    });
});

// Create a network
const container = document.getElementById('network');
const networkData = {
    nodes: new vis.DataSet(nodes),
    edges: new vis.DataSet(edges)
};
const options = {
    physics: {
        enabled: true,
        solver: "barnesHut",
        barnesHut: {
            gravitationalConstant: -30000,
            centralGravity: 0.1,
            springLength: 300,
            springConstant: 0.05,
            damping: 0.7,
            avoidOverlap: 1
        },
        stabilization: {
            enabled: true,
            iterations: 1000,
            updateInterval: 50,
            onlyDynamicEdges: false,
            fit: true
        },
        maxVelocity: 10,
        minVelocity: 0.1,
        timestep: 0.5,
        adaptiveTimestep: true
    },
    interaction: {
        dragNodes: true,
        dragView: true,
        zoomView: true,
        hover: true,
    },
    nodes: {
        borderWidth: 1,
        shape: 'ellipse',
        font: {
            size: 16
        },
        opacity: 1,
    },
    edges: {
        arrows: {
            to: { enabled: true, scaleFactor: 1 },
        },
        font: {
            align: 'middle'
        },
        smooth: {
            type: 'continuous'
        },
        color: {
            color: '#848484',
            opacity: 1,
            inherit: false,
        }
    },
    manipulation: {
        enabled: true,
        initiallyActive: false
    },
};
const network = new vis.Network(container, networkData, options);
